"""
Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ° Telegram-Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹.
Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ, Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ², Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°.
"""

import sys
import logging
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ConversationHandler,
    MessageHandler,
    filters,
)

from config import (
    BOT_TOKEN,
    DATABASE_PATH,
    STATE_TITLE,
    STATE_DESCRIPTION,
    STATE_ASSIGNEE,
    STATE_DEADLINE,
    STATE_PRIORITY,
    STATE_CONFIRM,
)
from database import Database

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸
from handlers.start import (
    start_command,
    help_command,
    menu_command,
    cancel_command,
    settings_command,
    timezone_command,
)
from handlers.team import (
    createteam_command,
    team_command,
    invite_command,
    join_command,
    leave_command,
)
from handlers.tasks import (
    newtask_command,
    task_title_received,
    task_description_received,
    task_description_skipped,
    task_assignee_selected,
    task_deadline_received,
    task_deadline_skipped,
    task_priority_selected,
    task_confirmed,
    mytasks_command,
    alltasks_command,
    today_command,
    week_command,
    task_detail_command,
)
from handlers.callbacks import callback_handler, comment_text_handler
from handlers.subscription import (
    subscribe_command,
    upgrade_command,
    billing_command,
)
from handlers.stats import stats_command, mystats_command
from handlers.calendar_handler import calendar_command
from scheduler.reminders import setup_scheduler

logger = logging.getLogger(__name__)


# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
async def error_handler(update, context) -> None:
    """Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº."""
    logger.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ: %s", context.error)
    # ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    if update and update.effective_message:
        try:
            await update.effective_message.reply_text(
                "âš ï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.",
                parse_mode="HTML",
            )
        except Exception:
            pass


# Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°
def main() -> None:
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°."""
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ°
    if not BOT_TOKEN or BOT_TOKEN == "your_bot_token_here":
        logger.critical("BOT_TOKEN Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½! Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ .env Ñ„Ğ°Ğ¹Ğ».")
        print("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: BOT_TOKEN Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½.")
        print("   Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ .env.example Ğ² .env Ğ¸ ÑƒĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°.")
        sys.exit(1)

    # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ‘Ğ”
    db = Database(DATABASE_PATH)

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
    app = Application.builder().token(BOT_TOKEN).job_queue(None).build()

    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ‘Ğ” Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ Ğ±Ğ¾Ñ‚Ğ°
    app.bot_data["db"] = db

    # â”€â”€â”€ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ConversationHandler Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡ â”€â”€â”€â”€â”€â”€

    task_conv_handler = ConversationHandler(
        entry_points=[CommandHandler("newtask", newtask_command)],
        states={
            STATE_TITLE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, task_title_received),
            ],
            STATE_DESCRIPTION: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, task_description_received),
                CallbackQueryHandler(task_description_skipped, pattern="^skip$"),
            ],
            STATE_ASSIGNEE: [
                CallbackQueryHandler(task_assignee_selected, pattern="^assign_"),
            ],
            STATE_DEADLINE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, task_deadline_received),
                CallbackQueryHandler(task_deadline_skipped, pattern="^skip$"),
            ],
            STATE_PRIORITY: [
                CallbackQueryHandler(task_priority_selected, pattern="^priority_"),
            ],
            STATE_CONFIRM: [
                CallbackQueryHandler(task_confirmed, pattern="^confirm_"),
            ],
        },
        fallbacks=[CommandHandler("cancel", cancel_command)],
        allow_reentry=True,
    )

    # â”€â”€â”€ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    # ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
    app.add_handler(CommandHandler("start", start_command))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("menu", menu_command))
    app.add_handler(CommandHandler("settings", settings_command))
    app.add_handler(CommandHandler("timezone", timezone_command))

    # Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Ğ¼Ğ¸
    app.add_handler(CommandHandler("createteam", createteam_command))
    app.add_handler(CommandHandler("team", team_command))
    app.add_handler(CommandHandler("invite", invite_command))
    app.add_handler(CommandHandler("join", join_command))
    app.add_handler(CommandHandler("leave", leave_command))

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡ (ConversationHandler)
    app.add_handler(task_conv_handler)

    # ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ·Ğ°Ğ´Ğ°Ñ‡
    app.add_handler(CommandHandler("mytasks", mytasks_command))
    app.add_handler(CommandHandler("alltasks", alltasks_command))
    app.add_handler(CommandHandler("today", today_command))
    app.add_handler(CommandHandler("week", week_command))
    app.add_handler(CommandHandler("task", task_detail_command))

    # ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°
    app.add_handler(CommandHandler("subscribe", subscribe_command))
    app.add_handler(CommandHandler("upgrade", upgrade_command))
    app.add_handler(CommandHandler("billing", billing_command))

    # Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
    app.add_handler(CommandHandler("stats", stats_command))
    app.add_handler(CommandHandler("mystats", mystats_command))

    # ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ
    app.add_handler(CommandHandler("calendar", calendar_command))

    # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° inline-ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº
    app.add_handler(CallbackQueryHandler(callback_handler))

    # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸)
    app.add_handler(
        MessageHandler(filters.TEXT & ~filters.COMMAND, comment_text_handler)
    )

    # Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
    app.add_error_handler(error_handler)

    # â”€â”€â”€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    scheduler = setup_scheduler(app.bot, db)

    # â”€â”€â”€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    logger.info("ğŸš€ Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ...")
    print("ğŸš€ Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½! ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ctrl+C Ğ´Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸.")

    try:
        app.run_polling(drop_pending_updates=True)
    except KeyboardInterrupt:
        logger.info("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ ÑĞ¸Ğ³Ğ½Ğ°Ğ» Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸")
    finally:
        # Graceful shutdown
        scheduler.shutdown(wait=False)
        db.close()
        logger.info("Ğ‘Ğ¾Ñ‚ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")
        print("ğŸ‘‹ Ğ‘Ğ¾Ñ‚ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½.")


if __name__ == "__main__":
    main()
